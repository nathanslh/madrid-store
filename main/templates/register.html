{% extends 'base.html' %}

{% block meta %}
<title>Register - Madrid Store</title>
{% endblock meta %}

{% block content %}
<div class="form-style">
  <div class="min-h-screen bg-gray-50 flex items-center justify-center p-8">
    <div class="max-w-md w-full relative z-10">
      <div class="bg-white border border-gray-200 rounded-lg p-8 shadow-sm">
      <div class="text-center mb-8">
        <h2 class="text-2xl font-semibold text-gray-900 mb-2">Join Us</h2>
        <p class="text-gray-500">Create your Madrid Store account</p>
      </div>

      <!-- Form Errors Display -->
      {% if form.non_field_errors %}
        <div class="mb-6">
          {% for error in form.non_field_errors %}
            <div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700">
              {{ error }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if form.errors %}
        <div class="mb-6">
          {% for field, errors in form.errors.items %}
            {% if field != '__all__' %}
              {% for error in errors %}
                <div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2">
                  <strong>{{ field|title }}:</strong> {{ error }}
                </div>
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <form id="registerForm" method="POST" action="" class="space-y-5">
        {% csrf_token %}
        
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <input 
            id="username" 
            name="username" 
            type="text" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-yellow-500 transition duration-200" 
            placeholder="Choose a username">
        </div>

        <div>
          <label for="password1" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <div class="relative">
            <input 
              id="password1" 
              name="password1" 
              type="password" 
              required 
              class="w-full px-4 py-3 pr-12 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition duration-200" 
              placeholder="Create a password">
            <button 
              type="button"
              onclick="togglePassword('password1')"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
              <svg id="password1-eye-closed" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
              </svg>
              <svg id="password1-eye-open" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
            </button>
          </div>
        </div>

        <div>
          <label for="password2" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
          <div class="relative">
            <input 
              id="password2" 
              name="password2" 
              type="password" 
              required 
              class="w-full px-4 py-3 pr-12 border border-gray-300 rounded focus:outline-none focus:border-yellow-500 transition duration-200" 
              placeholder="Confirm your password">
            <button 
              type="button"
              onclick="togglePassword('password2')"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
              <svg id="password2-eye-closed" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
              </svg>
              <svg id="password2-eye-open" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
            </button>
          </div>
        </div>

        <button 
          type="submit" 
          id="registerButton"
          class="w-full bg-yellow-500 text-white font-medium py-3 px-4 rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
          <span id="registerButtonText">Create Account</span>
          <svg id="registerSpinner" class="animate-spin h-5 w-5 text-white inline-block ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </form>

      <!-- Messages Display -->
      {% if messages %}
        <div class="mt-6">
          {% for message in messages %}
            <div 
              class="
                px-4 py-3 rounded text-sm border
                {% if message.tags == 'success' %}
                  bg-yellow-50 border-yellow-200 text-yellow-700
                {% elif message.tags == 'error' %}
                  bg-red-50 border-red-200 text-red-700
                {% else %}
                  bg-gray-50 border-gray-200 text-gray-700
                {% endif %}
              ">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="mt-6 text-center">
        <p class="text-gray-500 text-sm">
          Already have an account? 
          <a href="{% url 'main:login_user' %}" class="text-yellow-500 hover:text-yellow-600 font-medium">
            Sign In
          </a>
        </p>
      </div>
      </div>
    </div>
  </div>
</div>

<script>
function togglePassword(fieldId) {
  const passwordField = document.getElementById(fieldId);
  const eyeOpen = document.getElementById(fieldId + '-eye-open');
  const eyeClosed = document.getElementById(fieldId + '-eye-closed');
  
  if (passwordField.type === 'password') {
    passwordField.type = 'text';
    eyeClosed.classList.add('hidden');
    eyeOpen.classList.remove('hidden');
  } else {
    passwordField.type = 'password';
    eyeOpen.classList.add('hidden');
    eyeClosed.classList.remove('hidden');
  }
}

// Clear previous error messages
function clearErrorMessages() {
  const errorContainers = document.querySelectorAll('.error-message');
  errorContainers.forEach(container => container.remove());
}

// Show error messages
function showErrorMessages(errors) {
  clearErrorMessages();
  
  const form = document.getElementById('registerForm');
  const errorContainer = document.createElement('div');
  errorContainer.className = 'error-message mb-6';
  
  if (errors.non_field_errors) {
    errors.non_field_errors.forEach(error => {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2';
      errorDiv.textContent = error;
      errorContainer.appendChild(errorDiv);
    });
  }
  
  // Handle field-specific errors
  Object.keys(errors).forEach(fieldName => {
    if (fieldName !== 'non_field_errors' && fieldName !== '__all__') {
      errors[fieldName].forEach(error => {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2';
        errorDiv.innerHTML = `<strong>${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}:</strong> ${error}`;
        errorContainer.appendChild(errorDiv);
      });
    }
  });
  
  form.insertBefore(errorContainer, form.firstChild);
}

// Handle register form submission
document.getElementById('registerForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const registerButton = document.getElementById('registerButton');
  const registerButtonText = document.getElementById('registerButtonText');
  const registerSpinner = document.getElementById('registerSpinner');
  
  // Show loading state
  registerButton.disabled = true;
  registerButtonText.textContent = 'Creating Account...';
  registerSpinner.classList.remove('hidden');
  
  clearErrorMessages();
  
  const formData = new FormData(this);
  
  try {
    const response = await fetch('{% url "main:register" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Registration Successful', `Welcome, ${data.username}! Please sign in with your new account.`, 'success');
      
      // Redirect after short delay to show toast
      setTimeout(() => {
        window.location.href = data.redirect_url || '{% url "main:login_user" %}';
      }, 2000);
    } else {
      showErrorMessages(data.errors);
      showToast('Registration Failed', 'Please fix the errors and try again.', 'error');
    }
  } catch (error) {
    console.error('Register error:', error);
    showToast('Registration Error', 'An unexpected error occurred. Please try again.', 'error');
  } finally {
    // Reset button state
    registerButton.disabled = false;
    registerButtonText.textContent = 'Create Account';
    registerSpinner.classList.add('hidden');
  }
});
</script>
{% endblock content %}